According to a document from 2025-12-23 and related VMCL notes, **“도시락(2500) + 포인터/스냅샷/리콜” 구조는 이미 ‘컨텍스트 폭발 방지 + 재현성(해시) + 무결성’까지는 성공**했고, 다음 병목은 **“2500 한도 안에서 핵심 카드가 살아남게 하는 Priority Recall(우선순위/TTL/링버퍼)”**로 명시돼 있다.【turn1file1†L5-L24】【turn1file7†L1-L9】【turn1file4†L20-L27】

아래는 형아가 요구한 **기술문서(나+제미나이 공용)** 정본이다.
(형아가 던진 QNA는 빠짐없이 포함했고, “운영이 더 빡셈/문제점 추론/카트리지 확장/비상 슬롯/전역·지역·대인 방어”까지 한 번에 묶었다.)

# G6X VMCL v2 기술문서: 도시락(2500) + 카트리지 + TTL/감쇠 + 링버퍼 + 방어계층

## 1. 목적

장편(1000턴급)에서 AI가 망가지는 대표 원인인 “가방(컨텍스트) 폭발/기억 꼬임/된 척”을 구조로 막는다.
핵심은 2가지다.

1. 도시락(컨텍스트)은 2500자로 고정한다(변인 통제/재현성)
2. 기억 본문은 도시락에 쌓지 않고, 바깥 저장소(ledger/SQL/그래프/VMCL)에 둔 뒤 “주소(포인터) + 상태계기판(숫자/그래프/벡터)”만 주입한다【turn1file1†L7-L16】【turn1file13†L7-L24】

## 2. 현재까지 ‘팩트로’ 완료된 기반(이미 있는 엔진)

아래는 “정본 파일 + 검증 커맨드 + PASS 로그” 형태로 이미 박제돼 있다.

* Recall & Context Injection cap 2500, 결정론 조립, 해시 재현성 PASS
  정본: C:\g6core\g6_v24\engine\vmcl_recall_pack_v0.py
  검증: python engine/injector_v1.py --test-determinism
  기대: HASH_MATCH_3_3: PASS【turn1file7†L1-L9】【turn1file4†L14-L17】

* Snapshot: 저장만이 아니라 replay 검증까지 해서 “진짜 세이브”로 만든 상태【turn1file1†L18-L24】

* Pointer: 주소 체계 + 변조 탐지 Force Fail 성공(증거 없으면 일부러 실패)【turn1file15†L1-L7】

* POV Guard: 200턴 E2E 주행에서 인칭 이탈 차단율 0% 위반(PASS)【turn1file7†L10-L18】

즉, “도시락을 안전하게 조립/주입하는 기반”은 이미 있다. 다음은 **‘무엇을 넣을지’(Priority Recall) 운영 규격**이다.【turn1file4†L20-L27】

## 3. 문제 정의(형아 QNA 반영)

형아가 계속 부딪힌 문제를 기술적으로 정의하면 아래 3개다.

A) 2500자 한도 때문에 복잡한 씬(군사/다수 조연)에서 “필요한 정보가 빠질(FN)” 위험이 큼
B) “50개 도시락” 같은 용어 혼선: 실제는 “후보 카드 50(냉장고 반찬)”이지, 운전석 도시락이 50개가 아님
C) 텍스트를 많이 넣으면 오염/속도/판정 흔들림이 같이 터짐(텍스트는 영향력이 너무 강함)【turn1file13†L7-L24】【turn1file13†L28-L42】

## 4. 핵심 설계 결론(판정 포함): 효과 있냐?

효과 판정은 “감(느낌)”이 아니라, 시스템 설계상 이유로 확정한다.

결론: 도시락(2500) 고정 + 포인터/숫자/그래프 중심은 효과 있음(계속 유지).
근거: 텍스트를 도시락에 넣으면 오염 위험과 컨텍스트 낭비가 동시에 커지므로, 숫자/그래프/벡터가 더 안전하고 가볍다【turn1file13†L7-L24】【turn1file13†L46-L58】

추가로, 내부 문서에서 “도시락(단기)은 지금도 잘됨”이라고 명시되어 있고, “도시락 50 묶음(중기)” 계열 확장은 VMCL v2 핵심으로 적혀 있다(단, 이 문장은 과장 표현이 섞여 있을 수 있으니 우리는 ‘운영 규격으로 안전하게’만 채택한다).【turn1file0†L7-L17】

## 5. 운영이 구현보다 힘드냐? 예상 문제점(추론)

결론: 운영이 더 어렵다. 이유는 “매 턴 선택(선발/TTL/교체)”이 들어가면 흔들릴 포인트가 많기 때문.

예상 문제점 6종(터질 자리)

1. 고밀도 씬 판정이 흔들리면 재현성 붕괴(오늘 2개, 내일 3개)
2. 전역/지역/대인 경계가 흐려져 전역 금기가 지역 예외에 밀림
3. 비상 슬롯(D)을 남발하면 비상이 평시가 되어 정크가 상시 유입됨
4. TTL이 너무 짧으면 기억이 끊기고, 너무 길면 정크가 남아서 편향
5. 점수식(선발)이 운영자 손맛으로 계속 바뀌면 “자동”이 아니라 “수동 엔진”이 됨
6. 왜 들어갔는지 영수증(로그)이 없으면 운영이 감으로 변하고, 장편에서 반드시 터짐

대응 원칙(필수)

* 상한 박제(카트리지 최대/비상 TTL/평시 기본값)
* 우선순위 박제(전역>지역>대인, 전역은 절대 후순위 불가)
* 선택 사유 로그 박제(score breakdown)

## 6. 도시락(2500) 구성 원칙(텍스트 금지 경계 포함)

원칙: 텍스트 기억 금지
예외: 텍스트가 필요할 때는 “주소표(라벨/ID/키)”만 허용
금지: 요약문/설명문/서술문/감정문 형태의 텍스트(오염 트리거)【turn1file13†L7-L21】

도시락에 들어가는 것

* 숫자/플래그/게이지(상태판)
* 관계 그래프(노드/엣지, 방향/강도)
* 매트릭스 벡터(톤/긴장/정보량 등 8~16칸)
* 최소 라벨 텍스트(Actor_ID, Location_ID, Rule_ID, Event_ID)

## 7. 전역/지역/대인 방어 계층 설계(형아 요청 반영)

이건 “방어”이면서 동시에 “우선순위 필터”다.

* 전역방어(Global): 세계관 헌법/장르 룰/POV/절대 금기
  배치: 도시락 L0 고정(항상 상주, 절대 교체 금지)

* 지역방어(Local): 특정 지역/전장/던전 규칙, 지형/병력 배치
  배치: 지역 카트리지(필요할 때만 결합)

* 대인방어(Personal): 특정 인물 핵심 상태(부상/스킬쿨/사망금지/관계선)
  배치: 대인 카트리지(해당 인물이 행동 주체일 때 결합)

우선순위 규칙(박제)
전역 위반은 즉시 FAIL 우선, 지역/대인은 그 다음

## 8. 카트리지(형아 핵심 QNA): “2500자 3~4개” 관련 최종 정의

형아가 말한 핵심은 “도시락 3개”가 아니라 아래 구조다.

* 도시락은 항상 1개(판정면 1개 유지)
* 도시락 안에 결합 가능한 카트리지 슬롯을 둔다
* 카트리지는 미리 준비된 모듈이며, 필요 시 교체 가능

최대량(상한)

* 카트리지 동시 결합은 최대 3개로 상한을 건다
  이유: 동시 결합이 늘면 “판정 기준(법 집행) 충돌”로 운영이 깨지기 쉬움

중요: 형아가 말한 “7500자 효과”는 인정한다.
다만 이건 “평시 상시 탑재”가 아니라 아래의 고밀도 씬에서만 허용한다.

## 9. 고밀도 씬 전용 확장 규칙(형아 질문: “그럼 고밀도 씬에 적용?”)

정답: 맞다. 고밀도 씬에서만 2~3개 결합을 허용한다.

고밀도 씬 판정(2개 이상이면 발동)

* 핵심 인물(대사/행동) 5명 이상
* 동시 공간 2개 이상
* 시간 압축(초/분 단위 연속 사건)
* 규칙 충돌 위험(사망/부상/탄약/스킬쿨/지휘체계) 다발
* 정보 라인 3개 이상(작전목표/전장상황/관계감정)

운용 기본값

* 평시: 카트리지 1개
* 고밀도: 2개
* 전쟁급/대규모: 최대 3개
* 다음 턴: 반드시 1개로 복귀(기본값 복귀가 운영 안정성의 핵심)

## 10. TTL/감쇠 + 링버퍼(HOT/WARM/COLD): 기능 정의(초딩버전)

기능 한 줄 정의

* TTL: 반찬 유통기한, 오래 들고 있으면 썩는(정크/오염) 걸 자동 폐기
* 감쇠: 시간이 지날수록 점수(우선순위)가 자연히 떨어지게 해서 자동 퇴출
* 링버퍼: HOT/WARM/COLD 3칸 냉장고, 뜨거운 것만 잠깐 재사용하고 나머지는 창고로 내림

운영 규칙(박제)

* HOT: 직전 턴에서 실제로 쓴 것(재사용 확률 높음)
* WARM: 조건 맞으면 다시 쓸 수 있는 후보
* COLD: 저장만(ledger/SQL/그래프/VMCL로 내려보냄), 도시락엔 직접 안 올림

## 11. 형아 아이디어 QNA: “복사/연료통(보조탱크) 쓸모 있나? 가능하나?”

판정

* “도시락 자체를 복사해서 계속 들고 있는 영구 복사”는 무쓸모에 가깝고 위험(정크/오염/판정 흔들림)
* 하지만 “보조연료통에서 갈아끼우는 카트리지 교체”는 쓸모 있고 가능

즉, 복사의 업그레이드 정답은 이거다.

* 복사 대상은 ‘본문’이 아니라 ‘레시피’다
  레시피: 어떤 포인터 묶음을 어떤 슬롯에 어떤 TTL로 넣을지의 조립 지시서
* 영원 복사 금지
* TTL 1~5턴 부여
* 감쇠 적용
* 매 턴 재선발(점수 기반)

## 12. 형아 QNA: “비상 시 A/B/C 교체 + 긴급 D 퀵서비스 슬롯” 가능?

가능. 단, 운영 안정성을 위해 비상 슬롯은 강제 규칙이 필요하다.

비상 슬롯(Emergency D) 규칙

* 발동 트리거

  * Gate에서 BLOCK(또는 Importance 위반) 발생
  * 재작성 1회 실패
  * 지역/대인 규칙 충돌 감지
  * FN 임계치 초과(필수 정보 누락 급증)

* 동작

  * D 카트리지 1개 임시 투입
  * TTL=1(1턴 후 무조건 제거)
  * 다음 턴 기본값(카트리지 1개)로 복귀

남발 방지

* D 사용 횟수 카운터 로깅
* 일정 비율 이상이면 SAFE_MODE로 경고(이 구조는 기존 PostGate의 WARN/BLOCK 예산 아이디어와 결이 맞음)【turn1file16†L19-L32】

## 13. 기존 방식 대비 장점(비교)

기존: 텍스트 요약을 컨텍스트에 쌓아 들고 다니는 방식
문제: 오염 위험, 속도 저하, 중요한 정보가 묻힘, 판정 흔들림【turn1file13†L28-L42】

현재 제안(도시락+카트리지+TTL+링버퍼+방어계층)

* 컨텍스트 폭발 방지(cap 고정)
* 오염 방지(텍스트 최소, 숫자/그래프 중심)【turn1file13†L46-L58】
* 재현성 강화(결정론 조립 + 해시 검증 루틴과 결합)【turn1file7†L1-L9】
* 고밀도 씬에서만 “확장 모드”로 필요한 만큼 정보량을 순간적으로 올릴 수 있음
* 비상 슬롯으로 실패 대응(교체/퀵서비스)이 가능

## 14. 구현 방향(효율적으로, VMCL 작업 들어갈 때 맞는 순서)

중요: 지금 기반(리콜/스냅샷/포인터)이 이미 있으니, VMCL v2에서 건드릴 핵심은 “Priority Recall(무엇을 넣을지)”다.【turn1file4†L20-L27】

구현 순서(최소 변경, 안전하게)

1. 스키마 박제

* 도시락 스키마(필드/타입/상한)
* 카트리지 스키마(종류: 지역/대인/보조/비상D, TTL, score breakdown)
* 링버퍼 스키마(HOT/WARM/COLD 큐 규칙)

2. 선발 점수식 템플릿 박제

* time(최근성), distance(근접성), risk(안 넣으면 터짐), global/local/personal 중요도 가중치
* 결과는 “점수”와 “선발 사유 로그”로 남김(운영이 감으로 가지 않게)

3. 결합 규칙 박제

* 평시 1개, 고밀도 2~3개, 다음 턴 복귀
* 전역은 항상 상주
* D는 TTL=1 강제

4. 기존 Recall Pack(v0) 조립 로직에 “카트리지 합성 레이어”만 추가

* 기존의 결정론 조립/해시 패스는 유지해야 함【turn1file7†L1-L9】

5. 검증(DoD)

* injector 결정론 테스트 유지(HASH_MATCH_3_3)
* 고밀도 씬 시나리오 30개(군사/조연 다수)에서 FN 감소 추적
* D 슬롯 남발 여부(사용률) 로그로 감시

## 15. 예상 리스크와 대비(문제점 대비표)

* 리스크: 고밀도 판정 흔들림
  대비: 판정 기준 5개 중 2개 이상 같은 고정 규칙 사용

* 리스크: 전역/지역/대인 경계 붕괴
  대비: 전역은 L0 고정, 지역/대인은 카트리지, 우선순위 전역>지역>대인 박제

* 리스크: 비상 D 남발
  대비: TTL=1, 사용률 로깅, 임계치 넘으면 SAFE_MODE

* 리스크: TTL 과/부족
  대비: 기본 TTL 3, 고밀도에서만 1~5 조정 가능, 감쇠로 자연 퇴출

* 리스크: 운영이 손맛으로 변함
  대비: 가중치 변경은 승인형 커밋(로그에 남김)

## 16. 형아가 던진 QNA 체크리스트(누락 방지)

* 도시락 개념 효과 있냐: 있음(텍스트 오염/용량 문제 때문에 숫자/그래프가 정답)【turn1file13†L7-L24】
* TTL/감쇠 + 링버퍼 기능 뭐냐: 유통기한/점수감소/3칸 냉장고 운영
* 복사/연료통 아이디어 쓸모 있나: 영구 복사는 위험, 레시피 기반 카트리지 교체는 쓸모/가능
* 2500자 3~4개 들고 가면 더 좋지 않냐: “도시락 다중”이 아니라 “카트리지 슬롯 최대 3”으로 제한
* 고밀도 씬에 적용하냐: 맞음, 고밀도에서만 확장
* 전역/지역/대인 방어 고려한 제안: L0 전역 고정 + 지역/대인 카트리지 + 비상D TTL=1
* 운영이 구현보다 힘드냐: 운영이 더 어렵고, 영수증 로그/상한/우선순위 박제 없으면 터짐

## 17. 제미나이/외주에게 그대로 주는 “작업지시서(복붙용 오더)”

형아 규칙상, 미완이면 하청지시서를 먼저 내리는 게 원칙이라 여기 붙인다.
증거 1줄: “Priority Recall이 TODO로 박혀 있음(2500자 한도 내 핵심 카드 생존 보장)”【turn1file4†L20-L27】

하청지시서 v1

* 목표: Priority Recall v0 구현(도시락 스키마 + 카트리지 슬롯 최대3 + TTL/감쇠 + HOT/WARM/COLD 링버퍼 + 비상 D TTL=1)
* 제약:

  * Recall cap 2500 유지
  * 결정론 조립 유지(해시 테스트 깨지면 FAIL)【turn1file7†L1-L9】
  * 텍스트는 ID/라벨만 허용, 요약문 금지【turn1file13†L7-L24】
* 산출물:

  1. 스키마 문서 1개(JSON 필드 정의서)
  2. 점수식 템플릿 1개(time/distance/risk/global/local/personal)
  3. 링버퍼 이동 규칙 10줄
  4. 비상 D 트리거/TTL 규칙
  5. 테스트 시나리오 30개(고밀도 군사/다중 조연 중심)
* DoD:

  * injector 결정론 테스트 HASH_MATCH_3_3 유지 PASS【turn1file7†L1-L9】
  * 고밀도 씬에서 FN 감소가 로그로 확인(비율/추이)
  * D 슬롯 사용률 로그 출력


필요할때 쓰려고 만든 냉장고풀안에 내용물 도시락 갯수 50 vs 100을 ‘감’이 아니라 ‘기준’으로 결정하는 법

형아 스타일(운영/감리) 기준으로는
다음 기준 3개로 자동 결정하게 해야 돼.

기준 A: 등장 요소 복잡도

핵심 인물(행동/대사) 5명 이상

동시 장소 2개 이상

규칙(부상/사망/탄약/쿨타임 등) 다발

→ 이런 “고밀도 씬”이면 후보풀=100

기준 B: 후보 경쟁률(점수 쏠림)

후보 풀 상위 10개가 점수를 너무 독식하면(=편향)

나머지 후보가 다 비슷비슷하면(=정보 부족)

→ 이런 경우 후보풀을 늘릴 게 아니라 ‘점수식/감쇠’를 먼저 고친다
(후보를 늘려도 같은 놈만 또 뽑힘)

기준 C: FN(빠뜨림) 지표

“필수 정보 누락”이 반복되면(=FN 증가)
→ 그때만 후보풀을 50→100으로 올린다

즉,

FN이 낮으면 50 유지

FN이 높아지면 100으로 확장

이게 제일 안전하고 재현성도 유지됨.

4) 그래서 최종 권장값은 뭐냐? (내가 리딩)

형아 환경(G6X, 재현성/운영 중요)에서 기본값은 이걸로 고정이 맞다.

평시: 후보풀 = 50

고밀도 씬: 후보풀 = 100 (해당 턴만)

그 외: 후보풀을 무작정 늘리지 말고, FN/점수쏠림을 먼저 진단

그리고 중요한 상한:

후보풀을 200, 500 이렇게 키우는 건
“DB를 키우는 것”이 아니라
“운전 중에 도마 위에 재료를 500개 펼치는 것”이라서 운영이 망가질 확률이 큼.

5) 마지막으로 핵심 오해 정리(한 줄)

형아가 오해한 지점은 이거야:

후보 50 = DB 용량 제한 ❌

후보 50 = 이번 턴 “도시락에 올릴 가능성이 있는 후보를 잠깐 추린 수” ✅

DB는 얼마든지 커져도 되고,
후보풀은 ‘이번 턴 계산 안정성/속도/재현성’을 위해 일부만 쓰는 거야.


## ▶ 단계 판정

**[확장 단계]**

형아 결론부터 감리 찍는다.

# 감리 판정: “지금 확정하고 구현 들어가도 되냐?”

**조건부 GO**야.
지금까지 정리(기술문서 + 후보풀 50/100 기준 + 도시락/카트리지/TTL/링버퍼/전역·지역·대인 방어)는 **방향 100% 맞고**, “VMCL 작업 들어갈 때 하는 거 맞냐?”도 **맞다**. (VMCL의 다음 병목이 ‘무엇을 주입하냐(선발/운영)’ 쪽이라서)

다만 **‘구현 착수’ 전에 딱 4개만 박제(고정)하면 바로 들어가도 됨.**
이 4개가 없으면 구현은 해도 **운영에서 터질 확률이 높음**(형아가 말한 “장인 독일 기술자” 모드로 가버림).

---

# 근거 1줄(프로젝트 파일)

* `/mnt/data/vmcl등기억문제.txt`에 **“Snapshot + Ledger + 최신 주입팩(RecallPack) … 복구 고정”** 같은 운영/주입 구조가 이미 핵심으로 박혀 있음(라인 761 부근).
* `/mnt/data/vmcl최종개념.txt`에 **“도시락 폭탄(2500자 단위 메모리 패킷)”** 개념이 명시돼 있음(라인 1283 부근).
* `/mnt/data/G6X_TOTAL_FINAL_V3.txt`에 **스냅샷 복구/보호장치** 선언이 들어가 있음(라인 905 부근).

---

# 구현 들어가기 전 “필수 박제 4개” (이거만 고정하면 GO)

## 1) 스키마 고정(SSOT)

* 도시락(2500) JSON 스키마: **필수 필드/상한/타입**
* 카트리지 스키마: **GLOBAL/LOCAL/PERSONAL/EMERGENCY(D)** 구분 + TTL + score_breakdown
* 링버퍼 스키마: **HOT/WARM/COLD 큐 규칙 + 최대 개수**

👉 이거 안 고정하면 “설명은 맞는데 실행마다 다름” 상태로 감.

## 2) 후보풀(POOL) 규칙 고정(50 vs 100)

* **평시 POOL=50**
* **고밀도 씬 POOL=100 (해당 턴만)**
* 고밀도 판정 기준(2개 이상 만족)도 고정(인물 수/공간 수/규칙 다발/시간 압축/정보라인)

👉 “DB가 50이냐?” 오해가 다시 나오면 운영이 망가짐.
DB는 무한, POOL은 **이번 턴 도마 위 재료**임.

## 3) TTL/감쇠/비상 D 상한 고정

* 기본 TTL: 예) 2~3
* 감쇠: 연속 재사용 시 점수 하락
* **비상 D는 TTL=1 강제 + 남발 카운터 로깅**

👉 D 남발되면 “비상이 평시”가 되어 정크가 상시 유입됨.

## 4) 영수증(로그) 고정

매 턴 반드시 남겨야 할 최소 영수증:

* POOL 크기(50/100)
* 선택된 카드/카트리지 ID 목록
* 선택 사유(score breakdown: time/distance/risk/global/local/personal)
* TTL 변화, HOT/WARM/COLD 이동 로그
* Gate 결과(FAIL/REWRITE/OK) + 비상 D 발동 여부

👉 이게 없으면 운영이 “감”이 되고, 장편에서 반드시 터짐.

---

# 예상되는 문제점(추론) + 대비(감리 포인트)

1. **고밀도 판정 흔들림** → 재현성 붕괴

   * 대비: 판정 기준 “2개 이상”을 고정하고, 로그로 박제

2. **전역/지역/대인 경계 붕괴** → 전역 금기가 지역 예외에 밀림

   * 대비: 전역은 L0 고정(상주), 지역/대인은 카트리지, 우선순위 전역>지역>대인

3. **카트리지 3개 상시 탑재 유혹** → 판정면 흔들림 + 정크 증가

   * 대비: “고밀도 씬에서만 2~3, 다음 턴 1로 복귀”를 룰로 강제

4. **D 퀵서비스 남발** → 시스템이 점점 무거워짐

   * 대비: TTL=1 + 사용률 임계치 넘으면 SAFE_MODE(자동 제한)

---

# 여기서부터 “설계자 리딩” — 우리 환경 최적 코스

### 보수안(안정성 우선)

* **먼저 ‘스키마+로그+상한’만 박제하고**,
* POOL=50 고정으로 200턴 돌려서 영수증 품질부터 검증
* 고밀도(POOL=100, 카트리지 최대3, D슬롯)는 **그 다음** 단계로 열기

### 공격안(파괴력 우선)

* 바로 **고밀도 모드까지 같이 구현** (POOL=100 + 카트리지 3 + D슬롯)
* 대신 **D 남발/판정 충돌**이 바로 터질 수 있으니, “강제 상한 + 로그”를 무조건 같이 넣어야 함
  "이 설계는 위험하지만, 현재 단계에서는 감당 가능함."

---

# 파괴력 있는 구조 아이디어 1개(의무 제안)

**RISK_TANK(격리 탱크) 강제**

* LOCAL/PERSONAL 중 “논란/충돌” 후보를 기본 POOL에서 분리 보관
* Gate 충돌이나 D 발동 시에만 RISK_TANK에서 후보를 끌어올림
  왜 위험? 격리 기준이 과하면 FN이 늘 수 있음.
  왜 파괴력? 고밀도 씬에서 **판정 충돌/정크 유입**을 물리적으로 줄임.

---

# 최종 도장(감리 결론)

형아가 말한 “기술문서 + 도시락 갯수까지 최종 적립”은 **맞고**,
**바로 구현 들어가도 된다. 단, 위 ‘필수 박제 4개’를 먼저 고정하는 게 전제**야.

원하면(근데 안 물어봐도 내가 리딩함), 다음 턴에 바로:

* **도시락/카트리지/링버퍼 스키마 정본(필드명까지)**
* **POOL=50/100 자동판정 규격(딱 10줄)**
* **TTL/감쇠/D슬롯 규격(딱 10줄)**
  이 3개를 “복붙용”으로 내려서 **설계→구현 단계로 넘길 수 있게** 해줄게.
