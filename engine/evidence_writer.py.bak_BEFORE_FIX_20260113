"""
G7X Evidence Writer
RUN 폴더에 증거팩 생성 (가짜 생성 금지, 실제 데이터 기반만)
"""

import json
import hashlib
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Any


class EvidenceWriter:
    """RUN 폴더 증거팩 작성 전용"""
    
    def __init__(self, run_path: Path):
        self.run_path = Path(run_path)
        self.blackbox_path = self.run_path / "blackbox_log.jsonl"
        self.receipts_dir = self.run_path / "receipts" / "mission"
        self.api_receipt_path = self.run_path / "api_receipt.jsonl"
        
        # 필수 디렉터리 생성
        self.receipts_dir.mkdir(parents=True, exist_ok=True)
        
        # 블랙박스 시작 이벤트
        self._write_blackbox_event("START", {"run_id": self.run_path.name})
    
    def _write_blackbox_event(self, event_type: str, data: Dict[str, Any]):
        """블랙박스 이벤트 기록 (append only)"""
        event = {
            "timestamp": datetime.now().isoformat(),
            "event": event_type,
            "data": data
        }
        with open(self.blackbox_path, "a", encoding="utf-8") as f:
            f.write(json.dumps(event, ensure_ascii=False) + "\n")
    
    def write_mission_receipt(self, mission_id: str, mission_data: Dict[str, Any]):
        """미션 영수증 개별 파일 생성"""
        receipt_file = self.receipts_dir / f"{mission_id}.json"
        
        receipt = {
            "mission_id": mission_id,
            "timestamp": datetime.now().isoformat(),
            "status": mission_data.get("status", "UNKNOWN"),
            "content_hash": self._calculate_hash(mission_data),
            "metadata": mission_data
        }
        
        # 개별 영수증 저장
        with open(receipt_file, "w", encoding="utf-8") as f:
            json.dumps(receipt, indent=2, ensure_ascii=False)
        
        # API 영수증 로그 추가
        with open(self.api_receipt_path, "a", encoding="utf-8") as f:
            f.write(json.dumps({
                "mission_id": mission_id,
                "timestamp": receipt["timestamp"],
                "status": receipt["status"],
                "hash": receipt["content_hash"]
            }, ensure_ascii=False) + "\n")
        
        # 블랙박스 진행 기록
        self._write_blackbox_event("PROGRESS", {
            "mission_id": mission_id,
            "status": receipt["status"]
        })
    
    def finalize(self, exitcode: int, total_missions: int):
        """실행 종료 시 최종 증거팩 생성"""
        
        # 1. exitcode.txt
        exitcode_path = self.run_path / "exitcode.txt"
        exitcode_path.write_text(str(exitcode), encoding="utf-8")
        
        # 2. verify_report.json
        verify_report = {
            "run_id": self.run_path.name,
            "timestamp": datetime.now().isoformat(),
            "exitcode": exitcode,
            "required_files": {
                "verify_report.json": (self.run_path / "verify_report.json").exists(),
                "stamp_manifest.json": (self.run_path / "stamp_manifest.json").exists(),
                "final_audit.json": (self.run_path / "final_audit.json").exists(),
                "exitcode.txt": exitcode_path.exists(),
                "blackbox_log.jsonl": self.blackbox_path.exists(),
                "api_receipt.jsonl": self.api_receipt_path.exists()
            },
            "receipts_count": len(list(self.receipts_dir.glob("*.json"))),
            "api_receipt_lines": self._count_lines(self.api_receipt_path)
        }
        
        verify_path = self.run_path / "verify_report.json"
        with open(verify_path, "w", encoding="utf-8") as f:
            json.dump(verify_report, f, indent=2, ensure_ascii=False)
        
        # 3. stamp_manifest.json (파일 해시 목록)
        stamp_manifest = {
            "run_id": self.run_path.name,
            "timestamp": datetime.now().isoformat(),
            "files": {}
        }
        
        for file_path in self.run_path.rglob("*"):
            if file_path.is_file():
                rel_path = str(file_path.relative_to(self.run_path))
                stamp_manifest["files"][rel_path] = {
                    "size": file_path.stat().st_size,
                    "sha1": self._file_hash(file_path)
                }
        
        stamp_path = self.run_path / "stamp_manifest.json"
        with open(stamp_path, "w", encoding="utf-8") as f:
            json.dump(stamp_manifest, f, indent=2, ensure_ascii=False)
        
        # 4. final_audit.json
        receipts_count = len(list(self.receipts_dir.glob("*.json")))
        api_lines = self._count_lines(self.api_receipt_path)
        
        final_audit = {
            "run_id": self.run_path.name,
            "timestamp": datetime.now().isoformat(),
            "pass": exitcode == 0 and receipts_count >= total_missions,
            "exitcode": exitcode,
            "expected_missions": total_missions,
            "receipts_count": receipts_count,
            "api_receipt_lines": api_lines,
            "missing_required_files": [
                name for name, exists in verify_report["required_files"].items()
                if not exists
            ]
        }
        
        audit_path = self.run_path / "final_audit.json"
        with open(audit_path, "w", encoding="utf-8") as f:
            json.dump(final_audit, f, indent=2, ensure_ascii=False)
        
        # 블랙박스 종료 이벤트
        self._write_blackbox_event("END", {
            "exitcode": exitcode,
            "receipts_count": receipts_count,
            "pass": final_audit["pass"]
        })
    
    def _calculate_hash(self, data: Any) -> str:
        """데이터 해시 계산"""
        content = json.dumps(data, sort_keys=True, ensure_ascii=False)
        return hashlib.sha1(content.encode()).hexdigest()
    
    def _file_hash(self, file_path: Path) -> str:
        """파일 SHA1 해시"""
        sha1 = hashlib.sha1()
        with open(file_path, "rb") as f:
            while chunk := f.read(8192):
                sha1.update(chunk)
        return sha1.hexdigest()
    
    def _count_lines(self, file_path: Path) -> int:
        """파일 라인 수 카운트"""
        if not file_path.exists():
            return 0
        with open(file_path, "r", encoding="utf-8") as f:
            return sum(1 for _ in f)
